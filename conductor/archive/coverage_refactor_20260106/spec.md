# Specification: Coverage Boost & Strategic Refactor (Lending, WebServer, main)

## 1. Overview
本 Track 的目标是通过代码重构和测试用例扩展，系统性地提升项目的测试覆盖率。重点针对核心借贷逻辑 (`Lending.py`)、Web 服务层 (`WebServer.py`) 以及程序入口点 (`main.py`)。我们将通过剥离复杂逻辑和增加异常路径测试，确保系统的健壮性。

## 2. 功能需求

### 2.1 核心借贷引擎重构与测试 (`Lending.py`)
- **逻辑剥离**: 将 `LendingEngine` 中庞大的方法（如 `create_lend_offer`, `refresh_order_books`）拆分为纯计算函数和带副作用的 API 调用函数。
- **覆盖率提升**: 目标覆盖率从 ~54% 提升至 >70%。
- **测试扩展**: 增加边缘情况测试（如订单簿极值、高精度计算边界、API 间歇性失效）。
- **集成测试**: 引入模拟完整 Exchange API 响应周期的集成测试流程。

### 2.2 Web 服务器测试增强 (`WebServer.py`)
- **异常分支覆盖**: 重点针对网络连接超时、非法请求负载、文件系统权限错误等异常路径编写测试。
- **提升覆盖率**: 目标在现有 ~67% 的基础上进一步提升。

### 2.3 入口点逻辑剥离 (`main.py`)
- **Orchestrator 模式**: 将 `main.py` 中的初始化、依赖组装和机器人循环逻辑提取到名为 `BotOrchestrator` 的类中。
- **可测试性**: 使 `main.py` 仅作为最小化的执行入口，而核心编排逻辑可通过单元测试进行验证。

## 3. 非功能需求
- **代码质量**: 所有重构后的代码必须通过 `mypy` 和 `ruff` 检查。
- **测试标准**: 沿用 `pytest` 风格及现有的依赖注入 (DI) 模式。
- **回归保证**: 确保现有功能在重构后表现一致。

## 4. 验收标准 (Acceptance Criteria)
- [ ] `Lending.py` 的单元测试覆盖率达到 70% 以上。
- [ ] `main.py` 的核心编排逻辑已迁移至可测试的类，且拥有基本覆盖。
- [ ] 新增针对 Web 服务的异常路径测试用例。
- [ ] 所有单元测试和新增的集成测试全部通过。

## 5. 超出范围 (Out of Scope)
- 修改现有的借贷策略算法。
- 对前端 `www` 页面进行视觉或功能上的大规模调整。
